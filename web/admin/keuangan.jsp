<%@page import="java.text.NumberFormat"%><%@page import="java.util.Locale"%><%@page import="java.sql.*"%><%@page import="com.masjid.config.Koneksi"%><%@page contentType="text/html" pageEncoding="UTF-8"%><%if(session.getAttribute("adminId")==null){response.sendRedirect("../login.jsp");return;}String adminRole=(String)session.getAttribute("adminRole");if(adminRole==null)adminRole="Admin";boolean isAdmin=adminRole.contains("Admin");boolean isRiayah=adminRole.contains("Riayah");boolean canAccess=isAdmin||isRiayah;if(!canAccess){response.sendRedirect("dashboard.jsp?error=access");return;}boolean canAccessKegiatan=isAdmin||adminRole.contains("Imarah");boolean canAccessKeuangan=isAdmin||isRiayah;boolean canAccessArsip=isAdmin||adminRole.contains("Idarah");boolean canAccessUsers=isAdmin;Locale localeID=new Locale("in","ID");NumberFormat formatRupiah=NumberFormat.getCurrencyInstance(localeID);String startDate=request.getParameter("startDate");String endDate=request.getParameter("endDate");boolean hasFilter=(startDate!=null&&!startDate.isEmpty()&&endDate!=null&&!endDate.isEmpty());double totalPemasukan=0,totalPengeluaran=0;Connection conSum=null;try{conSum=Koneksi.getKoneksi();if(conSum!=null){Statement st=conSum.createStatement();ResultSet rs=st.executeQuery("SELECT kategori, SUM(jumlah) as total FROM keuangan GROUP BY kategori");while(rs.next()){if("Pemasukan".equalsIgnoreCase(rs.getString("kategori"))){totalPemasukan=rs.getDouble("total");}else{totalPengeluaran=rs.getDouble("total");}}rs.close();st.close();}}catch(Exception e){e.printStackTrace();}finally{if(conSum!=null)try{conSum.close();}catch(Exception e){}}double saldo=totalPemasukan-totalPengeluaran;double filteredPemasukan=0,filteredPengeluaran=0;if(hasFilter){Connection conFilter=null;try{conFilter=Koneksi.getKoneksi();if(conFilter!=null){PreparedStatement ps=conFilter.prepareStatement("SELECT kategori, SUM(jumlah) as total FROM keuangan WHERE tanggal >= ? AND tanggal <= ? GROUP BY kategori");ps.setString(1,startDate);ps.setString(2,endDate);ResultSet rs=ps.executeQuery();while(rs.next()){if("Pemasukan".equalsIgnoreCase(rs.getString("kategori"))){filteredPemasukan=rs.getDouble("total");}else{filteredPengeluaran=rs.getDouble("total");}}rs.close();ps.close();}}catch(Exception e){e.printStackTrace();}finally{if(conFilter!=null)try{conFilter.close();}catch(Exception e){}}}double filteredSaldo=filteredPemasukan-filteredPengeluaran;%><!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Kelola Keuangan - Admin Masjid</title><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#f0f2f5 0%,#e8eef3 100%);min-height:100vh}.sidebar{position:fixed;left:0;top:0;width:280px;height:100vh;background:linear-gradient(180deg,#1a5d3a 0%,#0d3320 100%);padding:25px 20px;z-index:100;box-shadow:4px 0 20px rgba(0,0,0,0.1);overflow-y:auto}.sidebar-header{text-align:center;padding:25px 0 35px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:30px}.sidebar-header .logo{font-size:50px;color:#ffd700;margin-bottom:15px}.sidebar-header h2{color:white;font-size:1.15rem}.sidebar-header p{color:rgba(255,255,255,0.6);font-size:0.85rem;margin-top:5px}.role-badge{display:inline-block;padding:4px 12px;background:rgba(255,215,0,0.2);color:#ffd700;border-radius:15px;font-size:0.75rem;margin-top:8px}.nav-menu{list-style:none}.nav-menu li{margin-bottom:8px}.nav-menu a{display:flex;align-items:center;gap:14px;padding:16px 20px;color:rgba(255,255,255,0.8);text-decoration:none;border-radius:12px;transition:all 0.3s ease}.nav-menu a i{font-size:1.2rem;width:24px;text-align:center}.nav-menu a:hover,.nav-menu a.active{background:rgba(255,255,255,0.15);color:white;transform:translateX(5px)}.nav-menu a.active{background:linear-gradient(90deg,rgba(255,215,0,0.2),transparent);border-left:3px solid #ffd700}.nav-menu .logout{margin-top:30px;border-top:1px solid rgba(255,255,255,0.1);padding-top:25px}.nav-menu .logout a{color:#ff6b6b}.main-content{margin-left:280px;padding:35px}.header{margin-bottom:30px;display:flex;align-items:center;gap:12px}.header h1{color:#333;font-size:1.8rem}.header i{color:#1a5d3a;font-size:1.6rem}.alert{padding:16px 22px;border-radius:12px;margin-bottom:25px;display:flex;align-items:center;gap:12px;font-size:0.95rem}.alert-success{background:linear-gradient(135deg,#e8f5e9,#c8e6c9);color:#2e7d32;border-left:4px solid #4caf50}.alert-error{background:linear-gradient(135deg,#ffebee,#ffcdd2);color:#c62828;border-left:4px solid #f44336}.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}.summary-card{background:white;border-radius:16px;padding:22px;display:flex;flex-direction:column;gap:12px;box-shadow:0 8px 25px rgba(0,0,0,0.05);position:relative;overflow:hidden}.summary-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}.summary-card.pemasukan::before{background:linear-gradient(90deg,#4caf50,#81c784)}.summary-card.pengeluaran::before{background:linear-gradient(90deg,#f44336,#e57373)}.summary-card.saldo::before{background:linear-gradient(90deg,#ff9800,#ffb74d)}.summary-card .icon-wrapper{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}.summary-card.pemasukan .icon-wrapper{background:linear-gradient(135deg,#e8f5e9,#c8e6c9);color:#4caf50}.summary-card.pengeluaran .icon-wrapper{background:linear-gradient(135deg,#ffebee,#ffcdd2);color:#f44336}.summary-card.saldo .icon-wrapper{background:linear-gradient(135deg,#fff3e0,#ffe0b2);color:#ff9800}.summary-card h4{color:#888;font-size:0.85rem;font-weight:500}.summary-card .amount{color:#333;font-size:1.3rem;font-weight:700}.card{background:white;border-radius:18px;padding:35px;box-shadow:0 8px 25px rgba(0,0,0,0.05);margin-bottom:30px}.card h3{color:#333;margin-bottom:28px;font-size:1.25rem;padding-bottom:18px;border-bottom:2px solid #f0f0f0;display:flex;align-items:center;gap:10px}.card h3 i{color:#1a5d3a}.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:22px}.form-group{margin-bottom:18px}.form-group label{display:flex;align-items:center;gap:8px;color:#555;font-weight:500;margin-bottom:10px}.form-group label i{color:#1a5d3a}.form-group input,.form-group select{width:100%;padding:14px 18px;border:2px solid #e8e8e8;border-radius:12px;font-family:'Poppins',sans-serif;transition:all 0.3s;font-size:0.95rem}.form-group input:focus,.form-group select:focus{outline:none;border-color:#1a5d3a;box-shadow:0 0 0 4px rgba(26,93,58,0.1)}.btn{padding:14px 32px;border:none;border-radius:12px;font-weight:600;cursor:pointer;font-family:'Poppins',sans-serif;transition:all 0.3s;display:inline-flex;align-items:center;gap:10px;font-size:0.95rem;text-decoration:none}.btn-primary{background:linear-gradient(135deg,#1a5d3a,#2e8b57);color:white}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(26,93,58,0.3)}.btn-secondary{background:linear-gradient(135deg,#f5f7fa,#e4e8ec);color:#555}.btn-info{background:linear-gradient(135deg,#2196f3,#64b5f6);color:white}.form-actions{margin-top:25px;display:flex;gap:15px;flex-wrap:wrap}.filter-form{display:flex;gap:15px;align-items:flex-end;flex-wrap:wrap;margin-bottom:25px;padding:20px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:12px}.filter-form .form-group{margin-bottom:0}.filter-results{background:linear-gradient(135deg,#e8f5e9,#c8e6c9);border-radius:12px;padding:20px;margin-bottom:20px}.filter-results h4{color:#2e7d32;margin-bottom:15px;display:flex;align-items:center;gap:8px}.filter-results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px}.filter-result-item{background:white;padding:15px;border-radius:10px;text-align:center}.filter-result-item .label{font-size:0.8rem;color:#666;margin-bottom:5px}.filter-result-item .value{font-size:1rem;font-weight:700}.filter-result-item .value.pemasukan{color:#4caf50}.filter-result-item .value.pengeluaran{color:#f44336}.filter-result-item .value.saldo{color:#ff9800}.table-wrapper{overflow-x:auto}table{width:100%;border-collapse:collapse;min-width:700px}thead{background:linear-gradient(135deg,#f8f9fa,#e9ecef)}th{padding:16px 14px;text-align:left;font-weight:600;color:#555;font-size:0.88rem}th i{margin-right:6px;color:#1a5d3a}td{padding:16px 14px;border-bottom:1px solid #f0f0f0;font-size:0.9rem}tr:hover{background:#fafafa}.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:0.82rem;font-weight:500}.badge.pemasukan{background:linear-gradient(135deg,#e8f5e9,#c8e6c9);color:#2e7d32}.badge.pengeluaran{background:linear-gradient(135deg,#ffebee,#ffcdd2);color:#c62828}.btn-edit,.btn-delete{padding:10px 18px;border:none;border-radius:10px;cursor:pointer;font-family:'Poppins',sans-serif;transition:all 0.3s;margin-right:8px;display:inline-flex;align-items:center;gap:6px;font-size:0.85rem;font-weight:500}.btn-edit{background:linear-gradient(135deg,#e3f2fd,#bbdefb);color:#1976d2}.btn-delete{background:linear-gradient(135deg,#ffebee,#ffcdd2);color:#d32f2f}.no-data{text-align:center;padding:60px;color:#999}.no-data i{font-size:50px;margin-bottom:15px;color:#ddd;display:block}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;backdrop-filter:blur(5px)}.modal.show{display:flex}.modal-content{background:white;border-radius:20px;padding:35px;width:90%;max-width:480px;max-height:90vh;overflow-y:auto}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;padding-bottom:18px;border-bottom:2px solid #f0f0f0}.modal-header h3{color:#333;display:flex;align-items:center;gap:10px}.modal-header h3 i{color:#1a5d3a}.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:#999}@media(max-width:992px){.sidebar{width:80px;padding:15px 10px}.sidebar-header h2,.sidebar-header p,.nav-menu a span,.role-badge{display:none}.sidebar-header .logo{font-size:35px}.nav-menu a{justify-content:center;padding:14px}.main-content{margin-left:80px}}@media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0;padding:20px}}</style></head><body><div class="sidebar"><div class="sidebar-header"><div class="logo"><i class="fas fa-mosque"></i></div><h2>Masjid Jabalussalam</h2><p>Admin Panel</p><span class="role-badge"><i class="fas fa-user-tag"></i> <%=adminRole%></span></div><ul class="nav-menu"><li><a href="dashboard.jsp"><i class="fas fa-gauge-high"></i><span>Dashboard</span></a></li><%if(canAccessKegiatan){%><li><a href="kegiatan.jsp"><i class="fas fa-calendar-days"></i><span>Kelola Kegiatan</span></a></li><%}%><%if(canAccessKeuangan){%><li><a href="keuangan.jsp" class="active"><i class="fas fa-money-bill-wave"></i><span>Kelola Keuangan</span></a></li><%}%><%if(canAccessArsip){%><li><a href="arsip.jsp"><i class="fas fa-folder-open"></i><span>Kelola Arsip</span></a></li><%}%><%if(canAccessUsers){%><li><a href="users.jsp"><i class="fas fa-users-cog"></i><span>Kelola User</span></a></li><%}%><li class="logout"><a href="../LogoutServlet"><i class="fas fa-right-from-bracket"></i><span>Logout</span></a></li></ul></div><div class="main-content"><div class="header"><i class="fas fa-money-bill-wave"></i><h1>Kelola Keuangan</h1></div><%if("add".equals(request.getParameter("success"))){%><div class="alert alert-success"><i class="fas fa-check-circle"></i> Transaksi berhasil ditambahkan!</div><%}else if("edit".equals(request.getParameter("success"))){%><div class="alert alert-success"><i class="fas fa-check-circle"></i> Transaksi berhasil diperbarui!</div><%}else if("delete".equals(request.getParameter("success"))){%><div class="alert alert-success"><i class="fas fa-check-circle"></i> Transaksi berhasil dihapus!</div><%}%><%if(request.getParameter("error")!=null){%><div class="alert alert-error"><i class="fas fa-exclamation-circle"></i> Terjadi kesalahan. Silakan coba lagi.</div><%}%><div class="summary-cards"><div class="summary-card pemasukan"><div class="icon-wrapper"><i class="fas fa-arrow-trend-up"></i></div><h4>Total Pemasukan</h4><div class="amount"><%=formatRupiah.format(totalPemasukan)%></div></div><div class="summary-card pengeluaran"><div class="icon-wrapper"><i class="fas fa-arrow-trend-down"></i></div><h4>Total Pengeluaran</h4><div class="amount"><%=formatRupiah.format(totalPengeluaran)%></div></div><div class="summary-card saldo"><div class="icon-wrapper"><i class="fas fa-wallet"></i></div><h4>Sisa Saldo</h4><div class="amount"><%=formatRupiah.format(saldo)%></div></div></div><div class="card"><h3><i class="fas fa-filter"></i> Filter Rentang Waktu</h3><form method="get" class="filter-form"><div class="form-group"><label><i class="fas fa-calendar-alt"></i> Tanggal Mulai</label><input type="date" name="startDate" value="<%=startDate!=null?startDate:""%>" required></div><div class="form-group"><label><i class="fas fa-calendar-alt"></i> Tanggal Akhir</label><input type="date" name="endDate" value="<%=endDate!=null?endDate:""%>" required></div><button type="submit" class="btn btn-info"><i class="fas fa-search"></i> Tampilkan</button><%if(hasFilter){%><a href="keuangan.jsp" class="btn btn-secondary"><i class="fas fa-times"></i> Reset</a><%}%></form><%if(hasFilter){%><div class="filter-results"><h4><i class="fas fa-chart-pie"></i> Hasil Filter: <%=startDate%> s/d <%=endDate%></h4><div class="filter-results-grid"><div class="filter-result-item"><div class="label">Pemasukan</div><div class="value pemasukan"><%=formatRupiah.format(filteredPemasukan)%></div></div><div class="filter-result-item"><div class="label">Pengeluaran</div><div class="value pengeluaran"><%=formatRupiah.format(filteredPengeluaran)%></div></div><div class="filter-result-item"><div class="label">Selisih</div><div class="value saldo"><%=formatRupiah.format(filteredSaldo)%></div></div></div></div><%}%></div><div class="card"><h3><i class="fas fa-plus-circle"></i> Tambah Transaksi Baru</h3><form action="../KeuanganServlet" method="post"><input type="hidden" name="action" value="add"><div class="form-grid"><div class="form-group"><label><i class="fas fa-calendar"></i> Tanggal</label><input type="date" name="tanggal" required></div><div class="form-group"><label><i class="fas fa-tag"></i> Kategori</label><select name="kategori" required><option value="">-- Pilih --</option><option value="Pemasukan">Pemasukan</option><option value="Pengeluaran">Pengeluaran</option></select></div><div class="form-group"><label><i class="fas fa-money-bill"></i> Jumlah (Rp)</label><input type="number" name="jumlah" required placeholder="Masukkan jumlah" min="0"></div><div class="form-group" style="grid-column:1/-1;"><label><i class="fas fa-file-alt"></i> Keterangan</label><input type="text" name="keterangan" required placeholder="Masukkan keterangan transaksi"></div></div><div class="form-actions"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Simpan</button><button type="reset" class="btn btn-secondary"><i class="fas fa-rotate-left"></i> Reset</button></div></form></div><div class="card"><h3><i class="fas fa-list"></i> Daftar Transaksi</h3><div class="table-wrapper"><table><thead><tr><th><i class="fas fa-calendar"></i> Tanggal</th><th><i class="fas fa-file-alt"></i> Keterangan</th><th><i class="fas fa-tag"></i> Kategori</th><th><i class="fas fa-money-bill"></i> Jumlah</th><th><i class="fas fa-cog"></i> Aksi</th></tr></thead><tbody><%boolean hasData=false;Connection con=null;try{con=Koneksi.getKoneksi();if(con!=null){String sql="SELECT * FROM keuangan";if(hasFilter){sql+=" WHERE tanggal >= '"+startDate+"' AND tanggal <= '"+endDate+"'";}sql+=" ORDER BY tanggal DESC";Statement st=con.createStatement();ResultSet rs=st.executeQuery(sql);while(rs.next()){hasData=true;int id=rs.getInt("id");String tgl=rs.getString("tanggal");String ket=rs.getString("keterangan");String kat=rs.getString("kategori");double jml=rs.getDouble("jumlah");if(ket==null)ket="";String ketJs=ket.replace("'","\\'").replace("\"","\\\"");%><tr><td><%=tgl%></td><td><%=ket%></td><td><span class="badge <%=kat.toLowerCase()%>"><i class="fas <%="Pemasukan".equalsIgnoreCase(kat)?"fa-arrow-up":"fa-arrow-down"%>"></i> <%=kat%></span></td><td><strong><%=formatRupiah.format(jml)%></strong></td><td><button class="btn-edit" onclick="openEdit(<%=id%>,'<%=tgl%>','<%=ketJs%>','<%=kat%>',<%=jml%>)"><i class="fas fa-pen-to-square"></i> Edit</button><form action="../KeuanganServlet" method="post" style="display:inline;" onsubmit="return confirm('Yakin hapus transaksi ini?')"><input type="hidden" name="action" value="delete"><input type="hidden" name="id" value="<%=id%>"><button type="submit" class="btn-delete"><i class="fas fa-trash-can"></i> Hapus</button></form></td></tr><%}rs.close();st.close();}}catch(Exception e){%><tr><td colspan="5" class="no-data"><i class="fas fa-exclamation-triangle"></i>Error: <%=e.getMessage()%></td></tr><%}finally{if(con!=null)try{con.close();}catch(Exception ex){}}if(!hasData){%><tr><td colspan="5" class="no-data"><i class="fas fa-wallet"></i>Belum ada data transaksi</td></tr><%}%></tbody></table></div></div></div><div class="modal" id="editModal"><div class="modal-content"><div class="modal-header"><h3><i class="fas fa-pen-to-square"></i> Edit Transaksi</h3><button class="modal-close" onclick="closeEdit()"><i class="fas fa-times"></i></button></div><form action="../KeuanganServlet" method="post"><input type="hidden" name="action" value="edit"><input type="hidden" name="id" id="e_id"><div class="form-group"><label><i class="fas fa-calendar"></i> Tanggal</label><input type="date" name="tanggal" id="e_tgl" required></div><div class="form-group"><label><i class="fas fa-file-alt"></i> Keterangan</label><input type="text" name="keterangan" id="e_ket" required></div><div class="form-group"><label><i class="fas fa-tag"></i> Kategori</label><select name="kategori" id="e_kat" required><option value="Pemasukan">Pemasukan</option><option value="Pengeluaran">Pengeluaran</option></select></div><div class="form-group"><label><i class="fas fa-money-bill"></i> Jumlah (Rp)</label><input type="number" name="jumlah" id="e_jml" required min="0"></div><div class="form-actions"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Simpan</button><button type="button" class="btn btn-secondary" onclick="closeEdit()"><i class="fas fa-times"></i> Batal</button></div></form></div></div><script>function openEdit(id,tgl,ket,kat,jml){document.getElementById('e_id').value=id;document.getElementById('e_tgl').value=tgl;document.getElementById('e_ket').value=ket;document.getElementById('e_kat').value=kat;document.getElementById('e_jml').value=jml;document.getElementById('editModal').classList.add('show');}function closeEdit(){document.getElementById('editModal').classList.remove('show');}document.getElementById('editModal').addEventListener('click',function(e){if(e.target===this)closeEdit();});</script></body></html>